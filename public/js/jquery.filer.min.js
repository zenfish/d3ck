/*!
 * jQuery Filer(Input File)
 * Copyright (c) 2013 CreativeDream
 * Website: http://creativedream.net/jquery.filer
 * Version: 1.2 (23-Aug-2014)
 * Requires: jQuery v1.7.1 or later
 */
(function(e){e.fn.filer=function(t){var n=e.extend({},e.fn.filer.defaults,t);this.each(function(t,r){var i,s=e(r),o,u=e("input:file").length==1?"":"-"+e("input:file").index(s),a,f={init:function(){i=this;k=[];i._changeInput();s.change(i.onChange);if(n.dragDrop&&!e.isEmptyObject(n.dragDrop)){i.dropZone=!n.dragDrop.dropBox?o?o:s:e(n.dragDrop.dropBox);i.dropZone.bind("drop",i._drop).bind("dragenter",i._dragEnter).bind("dragover",i._dragOver).bind("dragleave",i._dragLeave)}},_clickFile:function(e){if(o.find("#input-thumbs ul li").size()==0&&e.target!=o){s.click()}},_changeInput:function(){s.wrap('<div id="jfiler'+u+'"></div>');a=s.parent("#jfiler"+u);if(n.changeInput){switch(typeof n.changeInput){case"boolean":caption=n.captions;o=e('<div class="file"><span class="filer-button">'+caption.choose+'</span><span class="filer-feedback">'+caption.feedback+"</span></div>");s.after(o);break;case"string":o=e(n.changeInput);s.after(o);break}s.css({position:"absolute",left:"-9999px",top:"-9999px","z-index":"-9999"});o.on("click",i._clickFile)}if(n.limit>=2){s.attr("multiple","multiple");s.attr("name").slice(-2)!="[]"?s.attr("name",s.attr("name")+"[]"):null}},_clearInput:function(t){if(!t||o.length==0){s.val("");n.onEmpty!=null&&typeof n.onEmpty=="function"?n.onEmpty(s,i.appendTo?i.appendTo:"undefined"):null}if(n.changeInput){if(typeof n.changeInput=="boolean"){a.find(o).html('<span class="filer-button">'+caption.choose+'</span><span class="filer-feedback">'+caption.feedback+"</span>")}else{a.find(o).html(e(n.changeInput).html())}}a.find("div#input-thumbs").remove();a.find('input[name^="inputOrdBox"]').remove();i._setFeedbackText(0);k=[]},_setFeedbackText:function(e){var t=e==null?i.files.length:e,r=t==0?n.captions.feedback3:t+" "+n.captions.feedback2;a.find(".file .filer-feedback").text(r)},_inputFilesCheck:function(){var r=i.files,s=0;if(typeof r=="undefined"){return true}if(n.limit!=null&&r.length>n.limit){alert(n.captions.errors.filesLimit.replace(new RegExp("%allowed-limit%","g"),n.limit));return false}for(t=0;t<r.length;t++){var o=r[t].name.split(".").pop().toLowerCase();if(n.extensions!=null&&e.inArray(o,n.extensions)==-1&&(n.newExt==null||e.inArray(o,n.newExt)==-1)){alert(n.captions.errors.filesType.replace(new RegExp("%allowed-types%","g"),n.types));return false;break}if(n.maxSize!=null&&r[t].size>n.maxSize*1048576){alert(n.captions.errors.filesSize.replace(new RegExp("%file-name%","g"),r[t].name).replace(new RegExp("%maxSize%","g"),n.maxSize));return false;break}s+=r[t].size}if(n.maxSize!=null&&s>=Math.round(n.maxSize*1048576)){alert(n.captions.errors.filesSizeAll.replace(new RegExp("%maxSize%","g"),n.maxSize));return false}return true},_thumbBox:function(t,r,s){var o=i.files,u=n.maxChar,a=n.iconPath.slice(-1)!="/"?n.iconPath+"/":n.iconPath,f=i.appendTo.find("#input-thumbs ul");var l=o[t].name.indexOf(".")!=-1?o[t].name.split(".").pop().toLowerCase():"",c=o[t].name.slice(0,-l.length).length>=u?"...":"",h=o[t].name.slice(0,l.length==0?o[t].name.length:-l.length).slice(0,u-2)+c+l,p=o[t].name,d=(o[t].size/1048576).toString().slice(0,5),v=o[t].type.split("/",1).toString().toLowerCase(),m=n.removeFiles?' data-idx="'+t+'"':"",y=n.removeFiles?"<span></span>":"";switch(v){case"image":if(window.File&&window.FileList&&window.FileReader){var b=new FileReader;b.onload=function(n){var u='<img src="'+n.target.result+'" title="'+o[t].name+'" />';e(u).error(function(){alert(o[t].name+" is broken Image!");console.log("What are you trying to do with „"+o[t].name+"”?");i._clearInput()}).load(function(){g=i._tempChange(h,p,v,d,l,n.target.result,t,y,m);e(g).hide().find("img").load(function(){$(this).closest("li").prependTo(f);i._defaultSort();$(this).closest("li").fadeIn("slow",function(){i._onSelect(t,r,s)})})})};b.readAsDataURL(o[t])}else{g=i._tempChange(h,p,v,d,l,a+"image.png",t,y,m);e(g).hide().find("img").load(function(){$(this).closest("li").prependTo(f);i._defaultSort();$(this).closest("li").fadeIn("slow",function(){i._onSelect(t,r)})})}break;case"audio":g=i._tempChange(h,p,v,d,l,a+"audio.png",t,y,m);e(g).hide().find("img").load(function(){$(this).closest("li").prependTo(f);i._defaultSort();$(this).closest("li").fadeIn("slow",function(){i._onSelect(t,r)})});break;case"video":g=i._tempChange(h,p,v,d,l,a+"video.png",t,y,m);e(g).hide().find("img").load(function(){$(this).closest("li").prependTo(f);i._defaultSort();$(this).closest("li").fadeIn("slow",function(){i._onSelect(t,r)})});break;default:if(e.inArray(l,n.newExt)==-1){a+="file.png"}else{a+=l+".png"}g=i._tempChange(h,p,v,d,l,a,t,y,m);e(g).hide().find("img").load(function(){$(this).closest("li").prependTo(f);i._defaultSort();$(this).closest("li").fadeIn("slow",function(){i._onSelect(t,r)})});break}},_tempChange:function(e,t,r,i,s,o,u,a,f){var l={title:e,fileName:t,fileType:r,fileSize:i,fileExt:s,image:o,fileIndex:u,removeIcon:a,removeIndex:f};var c=n.template!=null&&typeof n.template=="function"?n.template(l):typeof n.template=="string"?n.template.replace(new RegExp("%title%","g"),l.title).replace(new RegExp("%original-name%","g"),l.fileName).replace(new RegExp("%type%","g"),l.fileType).replace(new RegExp("%size%","g"),l.fileSize).replace(new RegExp("%extension%","g"),l.fileExt).replace(new RegExp("%image-url%","g"),l.image).replace(new RegExp("%index%","g"),l.fileIndex).replace(new RegExp("%remove-icon%","g"),l.removeIcon).replace(new RegExp("%remove-index%","g"),l.removeIndex):null;return"<li"+l.removeIndex+">"+(c!=null&&c!=false?c:null)+"</li>"},_defaultSort:function(){var e=$(i.appendTo).find("#input-thumbs ul li").sort(function(e,t){var n=parseInt($(e).attr("data-idx"));var r=parseInt($(t).attr("data-idx"));return n<r?-1:n>r?1:0});$(i.appendTo).find("#input-thumbs ul").html(e)},onChange:function(r,o){var o=!o?s.get(0).files:o;i.files=o;if(o){if(!i._inputFilesCheck()){i._clearInput();return false}else{i._clearInput(o.length==0?false:true)}i._setFeedbackText();if(n.showThumbs){if(n.beforeShow!=null&&typeof n.beforeShow=="function"?!n.beforeShow(e(this),a):false){return false}if(n.appendTo!=null&&n.appendTo!="#jfiler"&&n.appendTo.length!=0){e(n.appendTo).html('<div id="input-thumbs"><ul /></div>');i.appendTo=e(n.appendTo);e("body").on("click",(typeof n.appendTo=="object"?n.appendTo.selector:n.appendTo)+" #input-thumbs ul li[data-idx] span, #input-thumbs ul li[data-idx] div.done-erase",function(t){i._remove(t,e(this))})}else{a.append('<div id="input-thumbs"><ul /></div>');i.appendTo=a;a.on("click","#input-thumbs ul li[data-idx] span, #input-thumbs ul li[data-idx] div.done-erase",function(t){i._remove(t,e(this))})}for(t=0;t<o.length;t++){i._thumbBox(t,e(this))}}else{for(t=0;t<o.length;t++){i._onSelect(t,e(this))}}}},_uploadFile:function(t,r,s){var o=new FormData,u=s[t],f=n.uploadFile,l=a.find("#input-thumbs ul li[data-idx^='"+t+"']");o.append(r,u);f.data&&!e.isEmptyObject(f.data)?e.each(f.data,function(e,t){o.append(e,t)}):null;e.ajax({url:f.url,type:"POST",enctype:"multipart/form-data",xhr:function(){myXhr=e.ajaxSettings.xhr();if(myXhr.upload){myXhr.upload.addEventListener("progress",function(e){i._progressHandling(e,l)},false)}return myXhr},beforeSend:function(){l.find(".progress-bar").remove();f.beforeSend!=null?f.beforeSend(l):null},success:function(e){f.success!=null?f.success(e,l,l.find(".progress-bar")):null;t==s.length-1&&f.onUploaded!=null?f.onUploaded(l):null},error:function(e){f.error!=null?f.error(e,l,l.find(".progress-bar")):null},data:o,cache:false,contentType:false,processData:false})},_progressHandling:function(e,t){if(e.lengthComputable){var n=Math.round(e.loaded*100/e.total).toString();t.find(".progress-bar").width(n+"%");if(n==100){i._progressHide(t)}}},_progressHide:function(e){setTimeout(function(){n.uploadFile.progressEnd&&n.uploadFile.progressEnd!=null?n.uploadFile.progressEnd(e.find(".progress-bar")):null},300)},_onSelect:function(t,r,o){if(n.uploadFile&&!e.isEmptyObject(n.uploadFile)){i._uploadFile(t,s.attr("name"),i.files)}n.onSelect!=null&&typeof n.onSelect=="function"?n.onSelect(r,a,i.appendTo?i.appendTo.find("#input-thumbs ul"):"undefined",i.appendTo?i.appendTo.find("li[data-idx='"+t+"']"):"undefined",i.files[t]):null;k.push(t);if(k.length>=i.files.length){n.afterShow!=null&&typeof n.afterShow=="function"?n.afterShow(r,a,i.appendTo?i.appendTo.find("#input-thumbs ul"):"undefined"):null}},_dragEnter:function(e){e.preventDefault();e.stopPropagation()},_dragOver:function(e){e.preventDefault();e.stopPropagation();n.dragDrop.dragOver?n.dragDrop.dragOver(e,i.dropZone):null},_dragLeave:function(e){e.preventDefault();e.stopPropagation();n.dragDrop.dragOut?n.dragDrop.dragOut(e,i.dropZone):null},_drop:function(e){e.preventDefault();var t=e.originalEvent.dataTransfer.files,r=new FormData;fileName=s.attr("name");for(var o=0;o<t.length;o++){r.append(fileName,t[o])}n.dragDrop.drop?n.dragDrop.drop(e,r,a):null;i.onChange(e,t)},_remove:function(t,r){if(!n.removeFiles||n.removeFiles==false){return}var o=r.parent().attr("data-idx"),f=e(i.appendTo).find("#input-thumbs ul li[data-idx='"+o+"']"),l=u.length==0?"-0":u;if(n.onRemove!=null&&typeof n.onRemove=="function"?n.onRemove(t,s,f,a,e(i.appendTo).find("#input-thumbs ul"),o):true){f.fadeOut(300,function(){e(this).remove();$items=e(i.appendTo).find("#input-thumbs ul li[data-idx]");if($items.length>0){var t=a.find('input[name^="inputOrdBox'+l+'"]');if(t.size()==0){var n=s+",";a.append('<input type="hidden" name="inputOrdBox'+l+'" value="'+n+'" />')}else{var n=t.val()+s+",";a.find('input[name^="inputOrdBox'+l+'"]').val(n)}i._setFeedbackText($items.length)}else{i._clearInput()}})}return false}};f.init()});return this};e.fn.filer.defaults={types:"Image, Audio, Video",limit:10,maxSize:3,extensions:["jpg","jpeg","png","gif","wmv","mp3","mp4"],newExt:null,changeInput:true,showThumbs:true,iconPath:"./images/",appendTo:null,maxChar:15,removeFiles:true,template:function(e){return'<img src="'+e.image+'" title="'+e.fileName+'" /><em>'+e.title+"</em> "+e.removeIcon+""},uploadFile:null,dragDrop:null,beforeShow:null,onSelect:null,afterShow:null,onRemove:null,onEmpty:null,captions:{choose:"Choose",feedback:"Choose files",feedback2:"files were chosen",feedback3:"No file chosen",errors:{filesLimit:"Only %allowed-limit% files are allowed to be uploaded",filesType:"Only %allowed-types% are allowed",filesSize:"%file-name% is too large! Please upload file up to %maxSize% MB",filesSizeAll:"Files you've choosed are too large! Please upload files up to %maxSize% MB"}}}})(jQuery);
